@* Reusable input using MudTextField with optional left icon; label and input laid out separately, custom outline on wrapper *@
@using MudBlazor

<div class="icon-input-root" style="@RootStyle">
    @if (!string.IsNullOrEmpty(Label))
    {
        <label for="@Id" class="icon-input-label">@Label</label>
    }
    <div class="icon-input-wrapper">
        @if (LeftIcon != null || !string.IsNullOrEmpty(LeftIconClass))
        {
            <div class="icon-input-adornment-start @(string.IsNullOrEmpty(LeftIconColor) ? "" : "icon-input-icon-colored")" style="@IconStyle">
                @if (LeftIcon != null)
                {
                    @LeftIcon
                }
            </div>
        }
        <MudTextField @id="Id"
                      T="string"
                      Placeholder="@Placeholder"
                      Value="@Value"
                      ValueChanged="OnValueChanged"
                      InputType="@ActualInputType"
                      Variant="Variant.Text"
                      Margin="Margin.None"
                      Class="icon-input-mud-field"
                      Immediate="true" />
        @if (ShowPasswordToggle)
        {
            <MudIconButton Icon="@(showPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                           Size="Size.Small"
                           OnClick="TogglePasswordVisibility"
                           aria-label="@(showPassword ? "Ocultar contraseña" : "Mostrar contraseña")"
                           Class="icon-input-toggle" />
        }
    </div>
    @if (BottomContent != null)
    {
        @BottomContent
    }
</div>

@code {
    [Parameter] public string Id { get; set; } = "";
    [Parameter] public string Label { get; set; } = "";
    [Parameter] public string Placeholder { get; set; } = "";
    [Parameter] public string Type { get; set; } = "text";
    [Parameter] public InputType? InputType { get; set; }
    [Parameter] public RenderFragment? LeftIcon { get; set; }
    [Parameter] public string? LeftIconClass { get; set; }
    [Parameter] public string? LeftIconColor { get; set; }
    [Parameter] public string BackgroundColor { get; set; } = "#ffffff";
    [Parameter] public string OutlineColor { get; set; } = "#cec497";
    [Parameter] public string BorderWidth { get; set; } = "1px";
    [Parameter] public string BorderRadius { get; set; } = "0.375rem";
    [Parameter] public string Height { get; set; } = "2.5rem";
    [Parameter] public bool ShowPasswordToggle { get; set; }
    [Parameter] public RenderFragment? BottomContent { get; set; }

    [Parameter] public string? Value { get; set; }
    [Parameter] public EventCallback<string?> ValueChanged { get; set; }

    private bool showPassword;

    private InputType ActualInputType
    {
        get
        {
            if (ShowPasswordToggle && showPassword) return MudBlazor.InputType.Text;
            if (InputType.HasValue) return InputType.Value;
            return Type?.ToLowerInvariant() switch
            {
                "email" => MudBlazor.InputType.Email,
                "password" => MudBlazor.InputType.Password,
                _ => MudBlazor.InputType.Text
            };
        }
    }

    private string RootStyle => $" --icon-input-bg: {BackgroundColor}; --icon-input-outline: {OutlineColor}; --icon-input-width: {BorderWidth}; --icon-input-radius: {BorderRadius}; --icon-input-height: {Height}; ";
    private string IconStyle => !string.IsNullOrEmpty(LeftIconColor) ? $"color: {LeftIconColor};" : "";

    private async Task OnValueChanged(string? value)
    {
        await ValueChanged.InvokeAsync(value);
    }

    private void TogglePasswordVisibility() => showPassword = !showPassword;
}
