@using MudBlazor
@rendermode InteractiveServer

<div class="client-form-card client-upload-card">
    <div class="client-upload-layout">
        <label for="client-file-input" class="client-upload-zone">
            <InputFile id="client-file-input" multiple
                       class="client-upload-input-hidden"
                       OnChange="OnFilesSelected" />
            <div class="client-upload-zone-inner">
                <MudIcon Icon="@Icons.Material.Outlined.FileUpload" Size="Size.Large" Class="client-upload-icon" Style="font-size: 5rem; width: 5rem; height: 5rem;" />
                <span class="client-upload-hint">Arrastra archivos ac√°</span>
                <span class="client-upload-sep"></span>
                <MudButton Variant="Variant.Filled"
                           Class="client-btn-browse"
                           OnClick="OpenFilePicker">
                    Buscar archivos
                </MudButton>
            </div>
        </label>
        <div class="client-files-section">
            <h3 class="client-files-title">Archivos Cargados</h3>
            <div class="client-files-list">
                @foreach (var file in uploadedFiles)
                {
                    <div class="client-file-item">
                        <MudIcon Icon="@Icons.Material.Outlined.Description" Size="Size.Small" Class="client-file-icon" />
                        <span class="client-file-name">@file.Name</span>
                        <div class="client-file-progress-wrap">
                            <div class="client-file-progress-bar" style="width: @(file.Progress)%"></div>
                        </div>
                        <MudIconButton Icon="@Icons.Material.Outlined.Delete"
                                       Size="Size.Small"
                                       Class="client-file-delete"
                                       OnClick="() => RemoveFile(file)"
                                       Title="Eliminar"
                                       aria-label="Eliminar" />
                    </div>
                }
                @if (uploadedFiles.Count == 0)
                {
                    <p class="client-files-empty">No hay archivos cargados</p>
                }
            </div>
        </div>
    </div>
    <div class="client-form-actions">
        <MudButton Variant="Variant.Filled"
                   EndIcon="@Icons.Material.Outlined.Close"
                   Class="client-btn client-btn-skip"
                   FullWidth="true"
                   OnClick="OnOmitirClick">
            Omitir
        </MudButton>
        <MudButton Variant="Variant.Filled"
                   EndIcon="@Icons.Material.Outlined.ArrowForward"
                   Class="client-btn client-btn-next"
                   FullWidth="true"
                   OnClick="OnSiguienteClick">
            Siguiente
        </MudButton>
    </div>
</div>

@inject IJSRuntime JS

@code {
    private List<UploadedFileEntry> uploadedFiles = new();
    private int nextId;

    [Parameter]
    public EventCallback OnOmitir { get; set; }

    [Parameter]
    public EventCallback OnSiguiente { get; set; }

    private async Task OpenFilePicker()
    {
        await JS.InvokeVoidAsync("eval", "document.getElementById('client-file-input')?.click()");
    }

    private async Task OnFilesSelected(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles())
        {
            var entry = new UploadedFileEntry { Id = ++nextId, Name = file.Name, Progress = 0 };
            uploadedFiles.Add(entry);
            StateHasChanged();
            // Simulate upload progress
            for (var p = 0; p <= 100; p += 15)
            {
                entry.Progress = Math.Min(p, 100);
                StateHasChanged();
                await Task.Delay(80);
            }
            entry.Progress = 100;
            StateHasChanged();
        }
    }

    private void RemoveFile(UploadedFileEntry file)
    {
        uploadedFiles.Remove(file);
    }

    private async Task OnOmitirClick() => await OnOmitir.InvokeAsync();
    private async Task OnSiguienteClick() => await OnSiguiente.InvokeAsync();

    private class UploadedFileEntry
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public int Progress { get; set; }
    }
}
